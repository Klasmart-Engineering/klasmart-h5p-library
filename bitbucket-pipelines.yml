definitions:
  caches:
    nodemodules: ./node_modules
  steps:
    - step: &fetch-npm-dependencies
        name: "Fetch NPM dependencies and build docker image"
        image: node:lts
        script:
          - npm ci
          - npm audit fix
        caches:
          - nodemodules
        artifacts:
          - node_modules/**/*
    - step: &slack-notification
        name: Slack Notification
        script:
          - pipe: atlassian/slack-notify:1.0.1
            variables:
              WEBHOOK_URL: 'https://hooks.slack.com/services/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'
              MESSAGE: 'A new build of H5P ($BITBUCKET_COMMIT) has been push with the "$BITBUCKET_BRANCH" tag'

  script: &build-and-push-to-aws
    - ls -la
    - pip3 install -U awscli

    - export BRANCH_TAG=$(echo "$BITBUCKET_BRANCH" | sed -E 's/([^0-9a-zA-Z]+)/-/g')
    - export REPO=$DOCKER_REPO_URL/kidsloop-h5p-service      # DOCKER_REPO_URL is workspace wide variable
    - docker build --build-arg SSH_PRIVATE_KEY="$(cat /opt/atlassian/pipelines/agent/ssh/id_rsa)" -t kidsloop-h5p-service .

    - aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin $DOCKER_REPO_URL

    - docker tag kidsloop-h5p-service:latest $REPO:$BRANCH_TAG
    - docker tag kidsloop-h5p-service:latest $REPO:$BRANCH_TAG-latest
    - docker tag kidsloop-h5p-service:latest $REPO:$BRANCH_TAG-$BITBUCKET_BUILD_NUMBER
    - docker tag kidsloop-h5p-service:latest $REPO:$BRANCH_TAG-${BITBUCKET_COMMIT:0:7}
    - docker push $REPO:$BRANCH_TAG
    - docker push $REPO:$BRANCH_TAG-latest
    - docker push $REPO:$BRANCH_TAG-$BITBUCKET_BUILD_NUMBER
    - docker push $REPO:$BRANCH_TAG-${BITBUCKET_COMMIT:0:7}

pipelines:
  branches:
    dev:
      - step: *fetch-npm-dependencies
    alpha:
      - step:
          name: Atlassian Security Secrets Scan
          script:
            - pipe: atlassian/git-secrets-scan:0.5.1
      - step: *fetch-npm-dependencies
      - step:
          name: "Push docker image to AWS"
          deployment: alpha
          image: python:3.9-alpine
          script: *build-and-push-to-aws
          services:
            - docker
          caches:
            - docker
      - step: *slack-notification
    production:
      - step:
          name: Atlassian Security Secrets Scan
          script:
            - pipe: atlassian/git-secrets-scan:0.5.1
      - step: *fetch-npm-dependencies
      - step:
          name: "Push docker image to AWS"
          deployment: production
          image: python:3.9-alpine
          script: *build-and-push-to-aws
          services:
            - docker
          caches:
            - docker
      - step: *slack-notification

  custom:
    deploy:
      - step:
          name: "Fetch NPM dependencies and build docker image"
          image: node:lts
          script:
            - npm i
            - ls -la
          caches:
            - nodemodules
          artifacts:
            - node_modules/**/*

      - step:
          name: "Push docker image to AWS"
          image: python:3.9-alpine
          script:
            - *build-and-push-to-aws
          services:
            - docker
          caches:
            - docker
