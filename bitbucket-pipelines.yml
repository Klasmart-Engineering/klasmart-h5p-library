pipelines:
  custom:
    deploy:
      - step:
          name: "Fetch NPM dependencies and build docker image"
          image: node:lts
          script:
            - npm i
            - ls -la
            - docker build -t kidsloop-h5p-service .
          services:
            - docker
          caches:
            - docker
            - nodemodules
            
      - step:
          name: "Push docker image to AWS"
          image: python:3.9-alpine
          script:
            - pip3 install -U awscli
            
            - export BRANCH_TAG=$(echo "$BITBUCKET_BRANCH" | sed -E 's/([^0-9a-zA-Z]+)/-/g')
            - export REPO=$DOCKER_REPO_URL/kidsloop-h5p-service      # DOCKER_REPO_URL is workspace wide variable

            - aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin $DOCKER_REPO_URL

            - docker tag kidsloop-h5p-service:latest $REPO:$BRANCH_TAG-latest
            - docker push $REPO:$BRANCH_TAG-latest

            - docker tag kidsloop-h5p-service:latest $REPO:$BRANCH_TAG-$BITBUCKET_BUILD_NUMBER
            - docker push $REPO:$BRANCH_TAG-$BITBUCKET_BUILD_NUMBER
          services:
            - docker
          caches:
            - docker

definitions:
  caches:
    nodemodules: ./node_modules